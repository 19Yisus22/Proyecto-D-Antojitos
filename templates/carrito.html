<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carrito | D'Antojitos ©</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/logo.ico') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_carrito.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

{% include 'navbar.html' %}

<main class="flex-grow-1 container mt-4">
    <h2 class="mb-4">Carrito de Pedidos</h2>
    <div id="carritoContainer" class="mb-4"></div>
    <button class="btn btn-success mt-3" id="btnFinalizarCompra" style="display:none;">Enviar Pedido</button>
    <div id="facturaContainer" class="mt-3"></div>
    <div class="mb-3 mt-4">
        <input type="text" id="buscarFactura" class="form-control" placeholder="Buscar por cédula o número de pedido">
    </div>
    <div id="facturasContainer" class="mb-4"></div>
    <nav>
        <ul class="pagination justify-content-center" id="paginacion"></ul>
    </nav>
</main>

<div id="toastContainer" class="position-fixed top-0 start-0 p-3"></div>

<div class="footer-container mt-5">
<footer class="footer py-4">
<div class="container footer-content d-flex flex-wrap justify-content-between align-items-start">
    <div class="footer-section">
        <h3>Contáctanos</h3>
        <div class="info-item"><i class="bi bi-person-fill"></i> Nombre: Teresa Rubio García</div>
        <div class="info-item"><i class="bi bi-telephone-fill"></i> Teléfono / WhatsApp: +57 3115699825</div>
        <div class="info-item"><i class="bi bi-envelope-fill"></i> Correo: terugag@hotmail.com</div>
        <div class="info-item"><i class="bi bi-geo-alt-fill"></i> Dirección: Carrera 4 #14-38 Urb. La Catalana - Chinácota - N.S</div>
        <div class="info-item"><i class="bi bi-clock-fill"></i> Horarios de atención: Jueves a Sábado, 9:00 AM - 6:00 PM</div>
    </div>
    <div class="footer-section">
        <h5>Síganos en:</h5>
        <a href="https://www.instagram.com/teresa.rubio.7311?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" class="social-icon text-light"><i class="bi bi-instagram"></i></a>
    </div>
    <div class="footer-section text-center">
        <h4>D'Antojitos</h4>
        <a href="/carrito_page"><img src="{{ url_for('static', filename='uploads/logo.ico') }}" alt="Logo" class="app-badge"></a>
    </div>
</div>
<div class="text-center mt-3 footer-bottom">
    <p>© 2025 Reposteria D'Antojitos - Todos los derechos reservados</p>
</div>
</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let ultimaFactura=null;
let facturasActuales=[];
let paginaActual=1;
const itemsPorPagina=5;

function showMessage(msg,isError=false){
    const toastContainer=document.getElementById('toastContainer');
    const toastEl=document.createElement('div');
    toastEl.className='toast align-items-center text-bg-light border-0';
    toastEl.setAttribute('role','alert');
    toastEl.setAttribute('aria-live','assertive');
    toastEl.setAttribute('aria-atomic','true');
    toastEl.innerHTML=`<div class="d-flex"><div class="toast-body">${isError?'❌':'✅'} ${msg}</div><button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
    toastContainer.appendChild(toastEl);
    new bootstrap.Toast(toastEl,{delay:1500}).show();
}

function mostrarFactura(data){
    const contenedor=document.getElementById("facturaContainer");
    contenedor.innerHTML=`<div class="card p-3">
        <h4 class="mb-3">Factura ID: ${data.pedidos[0]?.id_pedido||'N/A'}</h4>
        <p><strong>Cliente:</strong> ${data.pedidos[0]?.nombre_cliente||''}</p>
        <p><strong>Cédula:</strong> ${data.pedidos[0]?.cedula||''}</p>
        <p><strong>Dirección:</strong> ${data.pedidos[0]?.direccion_entrega||''}</p>
        <p><strong>Método de Pago:</strong> ${data.pedidos[0]?.metodo_pago||''}</p>
        <hr>
        <table class="table table-sm table-bordered mb-2">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody>
                ${data.pedidos.map(p=>`<tr>
                    <td>${p.nombre_producto}</td>
                    <td>x${p.cantidad}</td>
                    <td>${Number(p.total).toLocaleString('es-CO',{style:'currency',currency:'COP'})}</td>
                </tr>`).join('')}
            </tbody>
        </table>
        <p><strong>Total:</strong> ${Number(data.total).toLocaleString('es-CO',{style:'currency',currency:'COP'})}</p>
    </div>`;
}

async function generarFactura(){
    try{
        const res=await fetch("/finalizar_compra",{method:"POST"});
        const data=await res.json();
        if(res.ok){
            showMessage(data.message);
            ultimaFactura=data;
            mostrarFactura(data);
            cargarCarrito();
        }else{
            showMessage(data.message||"Error al finalizar compra",true);
        }
    }catch(e){
        showMessage("Error al finalizar compra",true);
    }
}

document.getElementById("btnFinalizarCompra").addEventListener("click",generarFactura);

async function cargarCarrito(){
    const contenedor=document.getElementById("carritoContainer");
    const botonFinal=document.getElementById("btnFinalizarCompra");
    contenedor.innerHTML="";
    botonFinal.style.display="none";
    try{
        const res=await fetch("/obtener_carrito");
        if(res.status===401||res.status===403){
            contenedor.innerHTML='<p class="text-center fw-bold fs-4 mt-4 text-danger">Inicie sesión para ver su carrito</p>';
            document.querySelectorAll("button, input, textarea").forEach(el=>el.disabled=true);
            return;
        }
        const data=await res.json();
        if(!data.productos||data.productos.length===0){
            contenedor.innerHTML='<p class="text-center fw-bold fs-4 mt-4 text-danger">Su carrito está vacío</p>';
            return;
        }
        const tabla=document.createElement("table");
        tabla.className="table table-bordered text-center align-middle";
        tabla.innerHTML=`<thead class="table-dark">
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <th colspan="3" class="text-end">Total</th>
                <th id="totalCarrito">COP 0</th>
                <th></th>
            </tr>
        </tfoot>`;
        contenedor.appendChild(tabla);
        const tbody=tabla.querySelector("tbody");
        let total=0;
        data.productos.forEach(item=>{
            const subtotal=Number(item.precio_unitario)*Number(item.cantidad);
            total+=subtotal;
            const imagen=item.imagen_url||'https://via.placeholder.com/70';
            const tr=document.createElement("tr");
            tr.dataset.id=item.id_carrito;
            tr.innerHTML=`<td class="d-flex flex-column align-items-center">
                <img src="${imagen}" class="img-preview mb-1" alt="${item.nombre_producto}">
                <div>${item.nombre_producto}</div>
                <div class="text-muted small">${item.descripcion||''}</div>
            </td>
            <td>x${item.cantidad}</td>
            <td>${Number(item.precio_unitario).toLocaleString('es-CO',{style:'currency',currency:'COP'})}</td>
            <td>${subtotal.toLocaleString('es-CO',{style:'currency',currency:'COP'})}</td>
            <td><button class="btn btn-danger btn-sm btn-quitar">Eliminar</button></td>`;
            tr.querySelector(".btn-quitar").addEventListener("click",async()=>{
                const delRes=await fetch(`/carrito_quitar/${item.id_carrito}`,{method:"DELETE"});
                if(delRes.ok){
                    tr.remove();
                    showMessage("Producto eliminado del carrito");
                    if(tbody.children.length===0){
                        contenedor.innerHTML='<p class="text-center fw-bold fs-4 mt-4 text-danger">Su carrito está vacío</p>';
                        botonFinal.style.display="none";
                    }else{
                        let nuevoTotal=0;
                        Array.from(tbody.children).forEach(r=>{
                            nuevoTotal+=Number(r.children[3].textContent.replace(/[^\d]/g,''));
                        });
                        document.getElementById("totalCarrito").textContent=nuevoTotal.toLocaleString('es-CO',{style:'currency',currency:'COP'});
                    }
                }else{
                    showMessage("No se pudo eliminar el producto",true);
                }
            });
            tbody.appendChild(tr);
        });
        document.getElementById("totalCarrito").textContent=total.toLocaleString('es-CO',{style:'currency',currency:'COP'});
        botonFinal.style.display="block";
    }catch(e){
        contenedor.innerHTML='<p class="text-center fw-bold fs-4 mt-4 text-danger">Error cargando carrito. Intente nuevamente.</p>';
    }
}

document.getElementById("buscarFactura").addEventListener("input",async function(){
    const query=this.value.trim();
    if(query.length===0){facturasActuales=[];mostrarFacturas();return;}
    try{
        const res=await fetch(`/buscar_facturas?q=${encodeURIComponent(query)}`);
        if(res.ok){
            facturasActuales=await res.json();
            paginaActual=1;
            mostrarFacturas();
        }
    }catch(e){
        showMessage("Error al buscar facturas",true);
    }
});

function mostrarFacturas(){
    const contenedor=document.getElementById("facturasContainer");
    contenedor.innerHTML="";
    const inicio=(paginaActual-1)*itemsPorPagina;
    const fin=inicio+itemsPorPagina;
    const facturasPage=facturasActuales.slice(inicio,fin);
    if(facturasPage.length===0){
        contenedor.innerHTML='<p class="text-center fw-bold fs-5 mt-4">No se encontraron facturas</p>';
        document.getElementById("paginacion").innerHTML='';
        return;
    }
    facturasPage.forEach(f=>{
        const div=document.createElement("div");
        div.className="card mb-2 p-2";
        div.innerHTML=`<strong>#${f.numero_factura}</strong><br>
            Cliente: ${f.nombre_cliente}<br>
            Cédula: ${f.cedula}<br>
            <table class="table table-sm table-bordered mt-2">
                <thead class="table-dark"><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead>
                <tbody>
                ${f.pedidos.map(p=>`<tr><td>${p.nombre_producto}</td><td>x${p.cantidad}</td><td>${Number(p.total).toLocaleString('es-CO',{style:'currency',currency:'COP'})}</td></tr>`).join('')}
                </tbody>
            </table>
            Total: ${Number(f.total).toLocaleString('es-CO',{style:'currency',currency:'COP'})}<br>
            Método de Pago: ${f.metodo_pago}<br>
            Fecha Emisión: ${new Date(f.fecha_emision).toLocaleString('es-CO')}`;
        contenedor.appendChild(div);
    });
    paginarFacturas();
}

function paginarFacturas(){
    const totalPaginas=Math.ceil(facturasActuales.length/itemsPorPagina);
    const pagContainer=document.getElementById("paginacion");
    pagContainer.innerHTML="";
    for(let i=1;i<=totalPaginas;i++){
        const li=document.createElement("li");
        li.className=`page-item ${i===paginaActual?'active':''}`;
        li.innerHTML=`<a class="page-link" href="#">${i}</a>`;
        li.addEventListener("click",e=>{
            e.preventDefault();
            paginaActual=i;
            mostrarFacturas();
        });
        pagContainer.appendChild(li);
    }
}

async function verFactura(id_factura){
    try{
        const res=await fetch(`/ver_factura/${id_factura}`);
        if(res.ok){
            const data=await res.json();
            mostrarFactura(data);
        }
    }catch(e){
        showMessage("Error al cargar factura",true);
    }
}

cargarCarrito();
</script>
</body>
</html>