<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil | D'Antojitos ©</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/logo.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_mi_perfil.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

{% include 'navbar.html' %}

<main class="container mt-4 mb-5">
    <div class="section-header text-center mb-5 fade-in">
        <h2 class="display-5 fw-bold">Mi Perfil</h2>
        <div class="divider mx-auto"></div>
    </div>
    
    <div class="card p-4 mb-4 shadow-sm fade-in border-0">
        <form id="formPerfil" enctype="multipart/form-data">
            <div class="d-flex flex-column align-items-center mb-4 position-relative">
                <div class="profile-img-container" style="width: 150px; height: 150px; position: relative;">
                    <img id="previewImagen" src="{{ user.imagen_url or '/static/default_icon_profile.png' }}" 
                         class="rounded-circle shadow-sm border" 
                         style="width: 100%; height: 100%; object-fit: cover; display: block;">
                    <label for="imagen_url" class="camera-btn" style="position: absolute; bottom: 5px; right: 5px; background: #fff; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #ddd;">
                        <i class="bi bi-camera-fill"></i>
                        <input type="file" id="imagen_url" name="imagen_url" accept="image/*" style="display:none" disabled>
                    </label>
                </div>
                <div class="mt-3">
                    {% if user.contrasena == 'GOOGLE_AUTH_EXTERNAL' %}
                    <span class="badge rounded-pill auth-badge bg-google shadow-sm p-2 px-3">
                        <img src="{{ url_for('static', filename='uploads/googlogo.ico') }}" width="16" class="me-2">Cuenta de Google
                    </span>
                    {% else %}
                    <span class="badge rounded-pill auth-badge bg-local shadow-sm p-2 px-3">
                        <i class="bi bi-envelope-fill me-2"></i>Correo D'Antojitos
                    </span>
                    {% endif %}
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Cédula</label>
                    <input type="text" id="cedulaPerfil" name="cedulaPerfil" class="form-control custom-input" value="{{ user.cedula or '' }}" required disabled>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Nombre</label>
                    <input type="text" id="nombrePerfil" name="nombrePerfil" class="form-control custom-input" value="{{ user.nombre or '' }}" disabled>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Apellido</label>
                    <input type="text" id="apellidoPerfil" name="apellidoPerfil" class="form-control custom-input" value="{{ user.apellido or '' }}" disabled>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Teléfono</label>
                    <input type="text" id="telefonoPerfil" name="telefonoPerfil" class="form-control custom-input" value="{{ user.telefono or '' }}" disabled>
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">Correo Electrónico</label>
                    <input type="email" id="correoPerfil" name="correoPerfil" class="form-control custom-input" value="{{ user.correo or '' }}" required disabled>
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">Dirección</label>
                    <textarea id="direccionPerfil" name="direccionPerfil" class="form-control custom-input" rows="2" required disabled>{{ user.direccion or '' }}</textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Método de Pago</label>
                    <select id="metodoPagoPerfil" name="metodoPagoPerfil" class="form-select custom-input" required disabled>
                        <option value="Efectivo" {% if user.metodo_pago=='Efectivo' %}selected{% endif %}>Efectivo</option>
                        <option value="Transferencia" {% if user.metodo_pago=='Transferencia' %}selected{% endif %}>Transferencia</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold text-muted">Rol del Usuario</label>
                    <input type="text" class="form-control custom-input bg-light" value="{{ (user.roles.nombre_role if user.roles else 'cliente') | capitalize }}" readonly disabled>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-primary px-4 btn-soft" id="btnEditarPerfil">
                    <i class="bi bi-pencil-square me-2"></i>Actualizar Datos
                </button>
                <button type="submit" class="btn btn-success px-4 btn-soft" id="btnActualizarPerfil" style="display:none">
                    <i class="bi bi-check-lg me-2"></i>Guardar Cambios
                </button>
            </div>

            <div class="mt-5 p-4 border rounded-3 bg-light-soft shadow-inner" id="seccionSeguridad" style="{% if user.contrasena == 'GOOGLE_AUTH_EXTERNAL' %}opacity: 0.7; pointer-events: none; background-color: #f1f1f1;{% endif %}">
                <h5 class="mb-4 text-secondary"><i class="bi bi-shield-lock me-2"></i>Seguridad</h5>
                {% if user.contrasena == 'GOOGLE_AUTH_EXTERNAL' %}
                <div class="alert alert-info py-2 small">
                    <i class="bi bi-info-circle me-2"></i> La seguridad se gestiona mediante Google Auth.
                </div>
                {% endif %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Nueva Contraseña</label>
                        <input type="password" id="nuevaContrasena" class="form-control custom-input" placeholder="********" {% if user.contrasena == 'GOOGLE_AUTH_EXTERNAL' %} disabled {% endif %}>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Verificar Contraseña</label>
                        <input type="password" id="confirmarContrasena" class="form-control custom-input" placeholder="********" {% if user.contrasena == 'GOOGLE_AUTH_EXTERNAL' %} disabled {% endif %}>
                    </div>
                </div>
                <button type="button" class="btn btn-warning w-100 mt-3 fw-bold text-uppercase" id="btnCambiarContrasena" {% if user.contrasena == 'GOOGLE_AUTH_EXTERNAL' %} disabled {% endif %}>Aplicar Contraseña</button>
            </div>
        </form>
    </div>

    {% if user.roles.nombre_role=='admin' %}
    <div class="admin-section mt-5 fade-in">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 text-primary d-flex align-items-center">
                <i class="bi bi-people-fill me-2"></i> Gestión de Usuarios
            </h4>
            <button id="btnExportarExcel" class="btn btn-success shadow-sm">
                <i class="bi bi-file-earmark-excel me-2"></i>Exportar Reporte
            </button>
        </div>

        <div class="card p-3 mb-4 shadow-sm border-0 bg-white">
            <div class="row g-3 align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="userSearch" class="form-control border-start-0" placeholder="Buscar por nombre o correo...">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="email" id="correoEliminar" class="form-control" placeholder="Correo a eliminar">
                        <button id="btnEliminarUsuario" class="btn btn-outline-danger">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm overflow-hidden">
            <div id="usuariosList" class="list-group list-group-flush"></div>
            <div class="card-footer bg-white py-3 d-flex justify-content-between align-items-center">
                <small class="text-muted">Mostrando <span id="countVisible">0</span> de <span id="countUsers">0</span> usuarios</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="paginationControls"></ul>
                </nav>
            </div>
        </div>
    </div>
    {% endif %}
</main>

<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script>
    const USER_ID = "{{ user.id_cliente }}";
    const USER_ROLE = "{{ user.roles.nombre_role if user.roles else 'cliente' }}";
    const USER_AUTH_GOOGLE = ("{{ user.contrasena }}" === "GOOGLE_AUTH_EXTERNAL");
</script>
<script src="{{ url_for('static', filename='js/perfil.js') }}"></script>
</body>
</html>