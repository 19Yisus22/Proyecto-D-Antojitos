<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfil del Usuario | D'Antojitos ©</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/logo.ico') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_mi_perfil.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

{% include 'navbar.html' %}

<main class="container mt-5" style="max-width: 900px;">
<h2>Mi Perfil</h2>
<div class="card p-4 mb-4">
<form id="formPerfil" enctype="multipart/form-data">
<div class="d-flex flex-column align-items-center mb-3 position-relative">
<img id="previewImagen" src="{{ user.imagen_url or '/static/uploads/default_icon_profile.png' }}" class="img-preview rounded-circle" width="120" height="120" style="object-fit:cover;cursor:pointer;">
<label for="imagen_url" class="position-absolute" style="bottom:0; right:calc(50% - 60px); cursor:pointer;">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#d35400" class="bi bi-camera-fill" viewBox="0 0 16 16">
<path d="M10.5 5.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 0 1H11v.5a.5.5 0 0 1-1 0V7.5h-.5a.5.5 0 0 1 0-1H10V6a.5.5 0 0 1 .5-.5z"/>
<path d="M4.5 3a1 1 0 0 0-1 1H2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.5a1 1 0 0 0-1-1h-5zM1 6a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6z"/>
</svg>
<input type="file" id="imagen_url" name="imagen_url" accept="image/*" style="display:none" disabled>
</label>
</div>

<input type="text" id="cedulaPerfil" name="cedulaPerfil" class="form-control mb-2" placeholder="Cédula" value="{{ user.cedula or '' }}" required disabled>
<input type="text" id="nombrePerfil" name="nombrePerfil" class="form-control mb-2" placeholder="Nombre" value="{{ user.nombre or '' }}" disabled>
<input type="text" id="apellidoPerfil" name="apellidoPerfil" class="form-control mb-2" placeholder="Apellido" value="{{ user.apellido or '' }}" disabled>
<input type="text" id="telefonoPerfil" name="telefonoPerfil" class="form-control mb-2" placeholder="Teléfono" value="{{ user.telefono or '' }}" disabled>
<input type="email" id="correoPerfil" name="correoPerfil" class="form-control mb-2" placeholder="Correo" value="{{ user.correo or '' }}" required disabled>
<textarea id="direccionPerfil" name="direccionPerfil" class="form-control mb-2" placeholder="Dirección" rows="2" required disabled>{{ user.direccion or '' }}</textarea>

<select id="metodoPagoPerfil" name="metodoPagoPerfil" class="form-select mb-2" required disabled>
<option value="">Seleccione método de pago</option>
<option value="Efectivo" {% if user.metodo_pago=='Efectivo' %}selected{% endif %}>Efectivo</option>
<option value="Transferencia" {% if user.metodo_pago=='Transferencia' %}selected{% endif %}>Transferencia (Nequi, Daviplata, Bancolombia, Nu)</option>
</select>
<select id="rolSelect" name="rol" class="form-select mb-2" disabled>
<option value="{{ user.roles.nombre_role }}" selected>{{ user.roles.nombre_role | capitalize }}</option>
</select>

<div class="d-flex justify-content-between">
<button type="button" class="btn btn-primary" id="btnEditarPerfil">Actualizar Datos</button>
<button type="submit" class="btn btn-success" id="btnActualizarPerfil" style="display:none">Guardar Datos</button>
</div>

<div class="mt-3">
<input type="password" id="nuevaContrasena" class="form-control mb-2" placeholder="Nueva contraseña">
<button type="button" class="btn btn-warning" id="btnCambiarContrasena">Cambiar Contraseña</button>
</div>
</form>
</div>

{% if user.roles.nombre_role=='admin' %}

<div class="container mt-4">
<div class="card p-4 mb-4">
<h5 class="mb-3">Eliminar usuarios por correo</h5>
<input type="email" id="correoEliminar" class="form-control mb-2" placeholder="Ingrese el correo">
<button id="btnEliminarUsuario" class="btn btn-danger">Eliminar Usuario</button>
</div>
<div class="card p-4">
<h5 class="mb-3">Usuarios registrados</h5>
<div id="usuariosList"></div>
</div>
</div>

{% endif %}

<div id="toastContainer" class="position-fixed top-0 start-0 p-3"></div>
<img src="{{ url_for('static', filename='uploads/logo.ico') }}" class="floating-logo" alt="Logo">

<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-3">
      <div class="card text-center border-0">
        <img id="modalImg" class="rounded-circle mx-auto mb-3" style="width:150px;height:150px;object-fit:cover;">
        <div class="card-body">
          <h5 id="modalNombre"></h5>
          <p><strong>ID:</strong> <span id="modalId"></span></p>
          <p><strong>Cédula:</strong> <span id="modalCedula"></span></p>
          <p><strong>Teléfono:</strong> <span id="modalTelefono"></span></p>
          <p><strong>Correo:</strong> <span id="modalCorreo"></span></p>
          <p><strong>Dirección:</strong> <span id="modalDireccion"></span></p>
          <p><strong>Método de Pago:</strong> <span id="modalMetodoPago"></span></p>
          <p><strong>Fecha de creación:</strong> <span id="modalFecha"></span></p>
          <span id="modalRol" class="badge bg-primary"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

const toastContainer=document.getElementById('toastContainer');

function showMessage(msg,isError=false){
  const toastEl=document.createElement('div');
  toastEl.className='toast align-items-center text-bg-light border-0';
  toastEl.setAttribute('role','alert');
  toastEl.setAttribute('aria-live','assertive');
  toastEl.setAttribute('aria-atomic','true');
  toastEl.innerHTML=`<div class="d-flex"><div class="toast-body">${isError?'❌':'✅'} ${msg}</div><button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  toastContainer.appendChild(toastEl);
  new bootstrap.Toast(toastEl,{delay:800}).show();
}

const previewImagen=document.getElementById("previewImagen");
const inputFile=document.getElementById("imagen_url");
inputFile.addEventListener("change",e=>{
  const file=e.target.files[0];
  if(file) previewImagen.src=URL.createObjectURL(file);
});

const formPerfil=document.getElementById("formPerfil");
const btnEditarPerfil=document.getElementById("btnEditarPerfil");
const btnActualizarPerfil=document.getElementById("btnActualizarPerfil");
const cedulaPerfil=document.getElementById("cedulaPerfil");
const nombrePerfil=document.getElementById("nombrePerfil");
const apellidoPerfil=document.getElementById("apellidoPerfil");
const telefonoPerfil=document.getElementById("telefonoPerfil");
const correoPerfil=document.getElementById("correoPerfil");
const direccionPerfil=document.getElementById("direccionPerfil");
const metodoPagoPerfil=document.getElementById("metodoPagoPerfil");
const rolSelect=document.getElementById("rolSelect");

btnEditarPerfil.addEventListener("click",()=>{
  cedulaPerfil.disabled=false;
  nombrePerfil.disabled=false;
  apellidoPerfil.disabled=false;
  telefonoPerfil.disabled=false;
  correoPerfil.disabled=false;
  direccionPerfil.disabled=false;
  metodoPagoPerfil.disabled=false;
  inputFile.disabled=false;
  btnActualizarPerfil.style.display="inline-block";
  btnEditarPerfil.style.display="none";
});

formPerfil.addEventListener("submit",async e=>{
  e.preventDefault();
  const formData=new FormData(formPerfil);
  const res=await fetch(`/actualizar_perfil/{{ user.id_cliente }}`,{method:"PUT",body:formData});
  const data=await res.json();
  if(res.ok&&data.ok){
    showMessage("Perfil Actualizado");
    previewImagen.src=data.usuario.imagen_url||previewImagen.src;
    cedulaPerfil.value=data.usuario.cedula||'';
    nombrePerfil.value=data.usuario.nombre||'';
    apellidoPerfil.value=data.usuario.apellido||'';
    telefonoPerfil.value=data.usuario.telefono||'';
    correoPerfil.value=data.usuario.correo||'';
    direccionPerfil.value=data.usuario.direccion||'';
    metodoPagoPerfil.value=data.usuario.metodo_pago||'';
    rolSelect.value=data.usuario.roles.nombre_role||'cliente';
    btnActualizarPerfil.style.display="none";
    btnEditarPerfil.style.display="inline-block";
    cedulaPerfil.disabled=true;
    nombrePerfil.disabled=true;
    apellidoPerfil.disabled=true;
    telefonoPerfil.disabled=true;
    correoPerfil.disabled=true;
    direccionPerfil.disabled=true;
    metodoPagoPerfil.disabled=true;
    rolSelect.disabled=true;
    inputFile.disabled=true;
  }else showMessage(data.error||"Error al actualizar perfil",true);
});

const btnCambiarContrasena=document.getElementById("btnCambiarContrasena");
btnCambiarContrasena.addEventListener("click",async()=>{
  const nueva=document.getElementById("nuevaContrasena").value.trim();
  if(!nueva){showMessage("Ingrese nueva contraseña",true);return;}
  const res=await fetch("/cambiar_contrasena",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({nueva})});
  const data=await res.json();
  if(res.ok&&data.ok){showMessage("Contraseña Actualizada");document.getElementById("nuevaContrasena").value="";}
  else showMessage(data.error||"Error al cambiar contraseña",true);
});

{% if user.roles.nombre_role=='admin' %}
const correoEliminar=document.getElementById("correoEliminar");
const btnEliminarUsuario=document.getElementById("btnEliminarUsuario");
const usuariosList=document.getElementById("usuariosList");

btnEliminarUsuario.addEventListener("click",async()=>{
  const correo=correoEliminar.value.trim();
  if(!correo){showMessage("Debe ingresar un correo válido.",true);return;}
  if(!confirm(`¿Está seguro de eliminar el usuario con correo ${correo}?`))return;
  const res=await fetch("/eliminar_usuario_por_correo",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({correo})});
  const data=await res.json();
  if(res.ok&&data.ok){showMessage("Usuario Eliminado");correoEliminar.value="";fetchUsuarios();}
  else showMessage(data.error||"Error al eliminar usuario",true);
});

async function fetchUsuarios(){
  const cached=localStorage.getItem('usuariosCache');
  if(cached){
    renderUsuarios(JSON.parse(cached));
  }
  const res=await fetch("/listar_usuarios");
  if(res.ok){
    const data=await res.json();
    localStorage.setItem('usuariosCache',JSON.stringify(data));
    renderUsuarios(data);
  }
}

function renderUsuarios(data){
  usuariosList.innerHTML="";
  let adminsCount=data.filter(u=>u.roles.nombre_role==="admin").length;
  data.forEach(u=>{
    const div=document.createElement("div");
    div.className="d-flex align-items-center justify-content-between mb-2";
    const leftDiv=document.createElement("div");
    leftDiv.className="d-flex align-items-center";
    const img=document.createElement("img");
    img.src=u.imagen_url||"/static/uploads/default_icon_profile.png";
    img.className="user-img-list";
    img.style.cursor="pointer";
    img.addEventListener("click",()=>{
      document.getElementById("modalImg").src=img.src;
      document.getElementById("modalId").textContent=u.id_cliente;
      document.getElementById("modalNombre").textContent=u.nombre+" "+u.apellido;
      document.getElementById("modalCedula").textContent=u.cedula||"";
      document.getElementById("modalTelefono").textContent=u.telefono||"";
      document.getElementById("modalCorreo").textContent=u.correo||"";
      document.getElementById("modalDireccion").textContent=u.direccion||"";
      document.getElementById("modalMetodoPago").textContent=u.metodo_pago||"";
      document.getElementById("modalFecha").textContent=new Date(u.fecha_creacion).toLocaleString("es-CO");
      document.getElementById("modalRol").textContent=u.roles.nombre_role;
      new bootstrap.Modal(document.getElementById("imgModal")).show();
    });
    const nombre=document.createElement("span");
    nombre.textContent=u.nombre+" "+u.apellido+" ("+u.correo+")";
    leftDiv.appendChild(img);
    leftDiv.appendChild(nombre);
    const rolUserSelect=document.createElement("select");
    rolUserSelect.className="form-select w-auto";
    rolUserSelect.innerHTML='<option value="cliente">Cliente</option><option value="admin">Admin</option>';
    rolUserSelect.value=u.roles.nombre_role;
    rolUserSelect.addEventListener("change",async()=>{
      if(rolUserSelect.value==="admin"&&adminsCount>=3){
        showMessage("Máximo 3 administradores permitidos",true);
        rolUserSelect.value=u.roles.nombre_role;
        return;
      }
      try{
        const resUpdate=await fetch("/actualizar_rol_usuario",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:u.id_cliente,rol:rolUserSelect.value})});
        const result=await resUpdate.json();
        if(resUpdate.ok&&result.ok){
          u.roles.nombre_role=rolUserSelect.value;
          adminsCount=data.filter(user=>user.roles.nombre_role==="admin").length;
          showMessage("Rol Actualizado");
        }else{
          showMessage(result.error||"Error al actualizar rol",true);
          rolUserSelect.value=u.roles.nombre_role;
        }
      }catch(error){
        showMessage("Error en la conexión con el servidor",true);
        rolUserSelect.value=u.roles.nombre_role;
      }
    });
    div.appendChild(leftDiv);
    div.appendChild(rolUserSelect);
    usuariosList.appendChild(div);
  });
}

fetchUsuarios();
{% endif %}

if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('/static/js/service-worker-perfil.js').then(()=>console.log('SW registrado')).catch(console.error));
}

</script>
</body>
</html>