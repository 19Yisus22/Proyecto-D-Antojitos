<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catálogo | D'Antojitos ©</title>
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='uploads/logo.ico') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_catalogo.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

{% include 'navbar.html' %}

<div class="container mt-4">
  <h1>Catálogo de Productos</h1>
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="Buscar productos...">
  <div class="d-flex justify-content-end align-items-center mb-3">
    <button class="btn btn-secondary btn-sm" id="btnFiltrar">Filtrar: Recientes</button>
  </div>
  <div id="spinner">
    <div class="spinner-border text-primary" role="status"></div>
  </div>
  <div class="row d-none" id="catalogoProductos"></div>
</div>

<button id="btnCarrito" data-count="0">
  <i class="bi bi-cart-fill"></i>
  <span id="contadorCarritoBadge">0</span>
</button>

<div id="toastContainer"></div>

<div class="footer-container mt-5">
  <footer class="footer py-4">
    <div class="container footer-content d-flex flex-wrap justify-content-between align-items-start">
      <div class="footer-section">
        <h3>Contáctanos</h3>
        <div class="info-item"><i class="bi bi-person-fill"></i> Nombre: Teresa Rubio García</div>
        <div class="info-item"><i class="bi bi-telephone-fill"></i> Teléfono / WhatsApp: +57 3115699825</div>
        <div class="info-item"><i class="bi bi-envelope-fill"></i> Correo: terugag@hotmail.com</div>
        <div class="info-item"><i class="bi bi-geo-alt-fill"></i> Dirección: Carrera 4 #14-38 Urb. La Catalana - Chinácota - N.S</div>
        <div class="info-item"><i class="bi bi-clock-fill"></i> Horarios de atención: Jueves a Sábado, 9:00 AM - 6:00 PM</div>
      </div>
      <div class="footer-section">
        <h5>Síganos en:</h5>
        <a href="https://www.instagram.com/teresa.rubio.7311?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" class="social-icon text-light"><i class="bi bi-instagram"></i></a>
      </div>
      <div class="footer-section text-center">
        <h4>D'Antojitos</h4>
        <a href="/catalogo_page"><img src="{{ url_for('static', filename='uploads/logo.ico') }}" alt="Logo" class="app-badge"></a>
      </div>
    </div>
    <div class="text-center mt-3 footer-bottom">
      <p>© 2025 Reposteria D'Antojitos - Todos los derechos reservados</p>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const catalogoContainer = document.getElementById("catalogoProductos");
const btnFiltrar = document.getElementById("btnFiltrar");
const searchInput = document.getElementById("searchInput");
const toastContainer = document.getElementById("toastContainer");
const btnCarrito = document.getElementById("btnCarrito");
const badgeCarrito = document.getElementById("contadorCarritoBadge");
let productos = [];
let filtroIndex = 0;
let contadorCarrito = 0;
const filtros = ['Recientes', 'Antiguos'];
const userLogged = {{ 'true' if session.get('user_id') else 'false' }};

function showMessage(msg,isError=false){
  const toastEl=document.createElement('div');
  toastEl.className='toast align-items-center text-bg-light border-0';
  toastEl.setAttribute('role','alert');
  toastEl.setAttribute('aria-live','assertive');
  toastEl.setAttribute('aria-atomic','true');
  toastEl.innerHTML=`<div class="d-flex"><div class="toast-body">${isError?'❌':'✅'} ${msg}</div><button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  toastContainer.appendChild(toastEl);
  const bsToast = new bootstrap.Toast(toastEl,{delay:800});
  bsToast.show();
  toastEl.addEventListener('hidden.bs.toast',()=>toastEl.remove());
}

function actualizarContadorCarrito(cantidad){
  contadorCarrito += cantidad;
  if(contadorCarrito < 0) contadorCarrito = 0;
  btnCarrito.setAttribute("data-count", contadorCarrito);
  if(contadorCarrito > 0){
    badgeCarrito.style.display = "inline-block";
    badgeCarrito.textContent = contadorCarrito;
  } else {
    badgeCarrito.style.display = "none";
  }
}

function renderProductos(filterText=''){
  catalogoContainer.innerHTML='';
  const filtrados = productos.filter(p=>p.nombre.toLowerCase().includes(filterText.toLowerCase()));
  filtrados.forEach(producto=>{
    const col=document.createElement("div");
    col.className="col-md-6 col-lg-4 mb-4";
    const imgUrl=producto.imagen_url||'/uploads/default.png';
    col.innerHTML=`
      <div class="card h-100" data-id="${producto.id_producto}" data-stock="${producto.stock}">
        <img src="${imgUrl}" class="card-img-top" alt="${producto.nombre}">
        <div class="card-body">
          <h5 class="card-title">${producto.nombre}</h5>
          <p class="fw-bold">Stock: <span class="stock">${producto.stock}</span></p>
          <p class="card-text">${producto.descripcion}</p>
          <p class="fw-bold">$${producto.precio.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</p>
          ${producto.stock>0?`
            <div class="quantity-control">
              <button class="btn btn-sm btn-outline-secondary btn-disminuir">-</button>
              <input type="number" min="1" max="${producto.stock}" value="1" class="form-control form-control-sm cantidad" style="width:60px;">
              <button class="btn btn-sm btn-outline-secondary btn-aumentar">+</button>
            </div>
            <button class="btn btn-primary mt-2 btn-agregar" ${!userLogged?'disabled':''}>Agregar al Carrito</button>`:
            '<div class="agotado-label">Agotado</div>'
          }
        </div>
      </div>
    `;
    catalogoContainer.appendChild(col);
  });
  agregarEventosProductos();
}

function agregarEventosProductos(){
  catalogoContainer.querySelectorAll(".btn-agregar").forEach(btn=>{
    btn.addEventListener("click",async e=>{
      e.stopPropagation();
      if(!userLogged){showMessage("Inicie sesión para agregar productos",true);return;}
      const card=btn.closest(".card");
      const id_producto=card.dataset.id;
      const nombre=card.querySelector(".card-title").textContent;
      let cantidad=parseInt(card.querySelector(".cantidad").value);
      const stock=parseInt(card.dataset.stock);
      if(cantidad>stock){cantidad=stock;card.querySelector(".cantidad").value=cantidad;}
      if(cantidad<=0){cantidad=1;card.querySelector(".cantidad").value=cantidad;}
      const res=await fetch("/guardar_catalogo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productos:[{id_producto,nombre_producto:nombre,cantidad}]})});
      const data=await res.json();
      if(res.ok){
        actualizarContadorCarrito(cantidad);
        card.dataset.stock=stock-cantidad;
        card.querySelector(".stock").textContent=stock-cantidad;
        card.querySelector(".cantidad").max=stock-cantidad;
        if(stock-cantidad<=0){
          card.querySelector(".quantity-control").remove();
          btn.remove();
          const agotadoDiv=document.createElement("div");
          agotadoDiv.className="agotado-label";
          agotadoDiv.textContent="Agotado";
          card.querySelector(".card-body").appendChild(agotadoDiv);
        }
        showMessage(data.message,false);
      }else{showMessage(data.error,true);}
    });
  });
  catalogoContainer.querySelectorAll(".btn-aumentar").forEach(btn=>{
    btn.addEventListener("click",e=>{
      e.stopPropagation();
      const input=btn.parentElement.querySelector(".cantidad");
      const stock=parseInt(btn.closest(".card").dataset.stock);
      if(!userLogged){showMessage("Inicie sesión para modificar cantidad",true);return;}
      if(parseInt(input.value)<stock)input.value=parseInt(input.value)+1;
    });
  });
  catalogoContainer.querySelectorAll(".btn-disminuir").forEach(btn=>{
    btn.addEventListener("click",e=>{
      e.stopPropagation();
      const input=btn.parentElement.querySelector(".cantidad");
      if(!userLogged){showMessage("Inicie sesión para modificar cantidad",true);return;}
      if(parseInt(input.value)>1)input.value=parseInt(input.value)-1;
    });
  });
}

async function cargarProductos(){
  try{
    const res=await fetch("/obtener_catalogo");
    const data=await res.json();
    productos=data.productos||[];
    renderProductos();
    document.getElementById("spinner").style.display="none";
    catalogoContainer.classList.remove("d-none");
    if(!userLogged){showMessage("Inicie sesión para agregar productos al carrito",true);}
  }catch(e){showMessage("Error al cargar los productos",true);}
}

btnFiltrar.addEventListener("click",()=>{
  filtroIndex=(filtroIndex+1)%filtros.length;
  const filtroActual=filtroIndex===0?'Recientes':'Antiguos';
  btnFiltrar.textContent=`Filtrar: ${filtroActual}`;
  if(filtroActual==='Recientes'){productos.sort((a,b)=>new Date(b.fecha||0)-new Date(a.fecha||0));}
  else{productos.sort((a,b)=>new Date(a.fecha||0)-new Date(b.fecha||0));}
  renderProductos(searchInput.value);
});

searchInput.addEventListener("input",()=>renderProductos(searchInput.value));

window.addEventListener("load",cargarProductos);

btnCarrito.addEventListener("click",()=>{
  if(!userLogged){showMessage("Inicie sesión para ver su carrito",true);return;}
  window.location.href="/carrito_page";
});
</script>
</body>
</html>