CREATE EXTENSION IF NOT EXISTS "pgcrypto";

DROP TABLE IF EXISTS facturas CASCADE;
DROP TABLE IF EXISTS comentarios CASCADE;
DROP TABLE IF EXISTS pedidos CASCADE;
DROP TABLE IF EXISTS pedido_detalle CASCADE;
DROP TABLE IF EXISTS carrito CASCADE;
DROP TABLE IF EXISTS gestion_productos CASCADE;
DROP TABLE IF EXISTS usuarios CASCADE;
DROP TABLE IF EXISTS roles_permisos CASCADE;
DROP TABLE IF EXISTS permisos CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS publicidad CASCADE;
DROP TABLE IF EXISTS metodos_pago CASCADE;

CREATE TABLE roles (
    id_role UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre_role TEXT UNIQUE NOT NULL CHECK (nombre_role IN ('admin','cliente','visitante')),
    descripcion TEXT
);

CREATE TABLE permisos (
    id_permiso UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre_permiso TEXT UNIQUE NOT NULL,
    descripcion TEXT
);

CREATE TABLE roles_permisos (
    id_role UUID REFERENCES roles(id_role) ON DELETE CASCADE,
    id_permiso UUID REFERENCES permisos(id_permiso) ON DELETE CASCADE,
    PRIMARY KEY (id_role, id_permiso)
);

CREATE TABLE usuarios (
    id_cliente UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    imagen_url TEXT DEFAULT 'static/uploads/default_icon_profile.png',
    nombre TEXT NOT NULL,
    apellido TEXT NOT NULL,
    telefono TEXT,
    correo TEXT UNIQUE NOT NULL,
    contrasena TEXT,
    id_role UUID REFERENCES roles(id_role),
    direccion TEXT,
    cedula TEXT UNIQUE,
    metodo_pago TEXT CHECK (metodo_pago IN ('Efectivo','Transferencia')) DEFAULT 'Efectivo',
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ultima_conexion TIMESTAMP WITH TIME ZONE
);

CREATE TABLE gestion_productos (
    id_producto UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre TEXT NOT NULL,
    descripcion TEXT,
    precio NUMERIC(12,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    imagen_url TEXT,
    categoria TEXT DEFAULT 'Postre',
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    estado BOOLEAN DEFAULT TRUE
);

CREATE TABLE carrito (
    id_carrito UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_cliente UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    id_producto UUID REFERENCES gestion_productos(id_producto) ON DELETE CASCADE,
    nombre_producto TEXT,
    cantidad INT NOT NULL CHECK (cantidad > 0),
    precio_unitario NUMERIC(12,2) NOT NULL,
    total NUMERIC(12,2) NOT NULL,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE pedidos (
    id_pedido UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_cliente UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    direccion_entrega TEXT NOT NULL,
    metodo_pago TEXT CHECK (metodo_pago IN ('Efectivo','Transferencia')),
    estado TEXT NOT NULL DEFAULT 'Pendiente' CHECK (estado IN ('Pendiente','Enviado','Entregado','Cancelado')),
    pagado BOOLEAN DEFAULT FALSE,
    fecha_pedido TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total NUMERIC(12,2) NOT NULL
);

CREATE TABLE facturas (
    id_factura UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_pedido UUID REFERENCES pedidos(id_pedido) ON DELETE CASCADE,
    id_cliente UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    id_pago UUID REFERENCES metodos_pago(id_pago) ON DELETE SET NULL, -- LLAVE FORÁNEA
    numero_factura SERIAL UNIQUE,
    fecha_emision TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    subtotal NUMERIC(12,2) NOT NULL,
    total NUMERIC(12,2) NOT NULL,
    metodo_pago TEXT CHECK (metodo_pago IN ('Efectivo','Transferencia')),
    estado TEXT DEFAULT 'Emitida' CHECK (estado IN ('Emitida', 'Anulada', 'Pagada')),
    cedula TEXT
);

CREATE TABLE metodos_pago (
    id_pago UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entidad TEXT NOT NULL CHECK (entidad IN ('Nequi', 'Daviplata', 'Bancolombia', 'NuBank')),
    tipo_cuenta TEXT NOT NULL CHECK (tipo_cuenta IN ('Billetera Digital', 'Ahorros', 'Corriente')),
    numero TEXT NOT NULL,
    titular TEXT NOT NULL,
    qr_url TEXT,
    estado BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE pedido_detalle (
    id_detalle UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_pedido UUID REFERENCES pedidos(id_pedido) ON DELETE CASCADE,
    id_producto UUID REFERENCES gestion_productos(id_producto) ON DELETE RESTRICT,
    nombre_producto TEXT NOT NULL,
    cantidad INT NOT NULL CHECK (cantidad > 0),
    precio_unitario NUMERIC(12,2) NOT NULL CHECK (precio_unitario >= 0),
    subtotal NUMERIC(12,2) NOT NULL
);

CREATE TABLE comentarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_usuario UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    nombre_usuario TEXT NOT NULL,
    correo_usuario TEXT NOT NULL,
    foto_perfil TEXT,
    mensaje TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE comentarios 
ADD COLUMN likes_usuarios JSONB DEFAULT '[]'::jsonb;

CREATE TABLE publicidad (
    id_publicidad UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tipo TEXT NOT NULL CHECK (tipo IN ('carrusel', 'seccion', 'notificacion', 'cinta')),
    titulo TEXT,
    descripcion TEXT,
    imagen_url TEXT,
    estado BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE permisos ENABLE ROW LEVEL SECURITY;
ALTER TABLE roles_permisos ENABLE ROW LEVEL SECURITY;
ALTER TABLE usuarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE gestion_productos ENABLE ROW LEVEL SECURITY;
ALTER TABLE carrito ENABLE ROW LEVEL SECURITY;
ALTER TABLE pedidos ENABLE ROW LEVEL SECURITY;
ALTER TABLE facturas ENABLE ROW LEVEL SECURITY;
ALTER TABLE pedido_detalle ENABLE ROW LEVEL SECURITY;
ALTER TABLE comentarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE publicidad ENABLE ROW LEVEL SECURITY;

CREATE OR REPLACE FUNCTION public.es_admin()
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM public.usuarios
        WHERE id_cliente = auth.uid()
        AND id_role = (SELECT id_role FROM public.roles WHERE nombre_role = 'admin' LIMIT 1)
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION public.actualizar_ultima_conexion()
RETURNS TRIGGER AS $$
BEGIN
    NEW.ultima_conexion = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION public.asignar_rol_cliente()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id_role IS NULL THEN
        NEW.id_role := (SELECT id_role FROM public.roles WHERE nombre_role='cliente' LIMIT 1);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION public.handle_user_login()
RETURNS TRIGGER AS $$
DECLARE
    default_role_id UUID;
BEGIN
    SELECT id_role INTO default_role_id FROM public.roles WHERE nombre_role = 'cliente' LIMIT 1;
    INSERT INTO public.usuarios (id_cliente, correo, nombre, apellido, imagen_url, id_role, cedula, telefono, direccion, contrasena)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'given_name', NEW.raw_user_meta_data->>'nombre', 'Usuario'),
        COALESCE(NEW.raw_user_meta_data->>'family_name', NEW.raw_user_meta_data->>'apellido', 'Google'),
        COALESCE(NEW.raw_user_meta_data->>'picture', 'static/uploads/default_icon_profile.png'),
        default_role_id,
        COALESCE(NEW.raw_user_meta_data->>'cedula', 'G-' || SUBSTR(NEW.id::text, 1, 8)),
        COALESCE(NEW.raw_user_meta_data->>'phone', NEW.raw_user_meta_data->>'telefono', ''),
        COALESCE(NEW.raw_user_meta_data->>'address', NEW.raw_user_meta_data->>'direccion', ''),
        'GOOGLE_AUTH_EXTERNAL'
    )
    ON CONFLICT (id_cliente) DO UPDATE SET
        ultima_conexion = NOW(),
        imagen_url = COALESCE(NEW.raw_user_meta_data->>'picture', public.usuarios.imagen_url),
        telefono = COALESCE(NEW.raw_user_meta_data->>'phone', NEW.raw_user_meta_data->>'telefono', public.usuarios.telefono),
        direccion = COALESCE(NEW.raw_user_meta_data->>'address', NEW.raw_user_meta_data->>'direccion', public.usuarios.direccion);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

DROP TRIGGER IF EXISTS trg_actualizar_conexion ON public.usuarios;
CREATE TRIGGER trg_actualizar_conexion
BEFORE UPDATE ON public.usuarios
FOR EACH ROW
WHEN (OLD.* IS DISTINCT FROM NEW.*)
EXECUTE FUNCTION actualizar_ultima_conexion();

DROP TRIGGER IF EXISTS trg_asignar_rol_cliente ON public.usuarios;
CREATE TRIGGER trg_asignar_rol_cliente
BEFORE INSERT ON public.usuarios
FOR EACH ROW EXECUTE FUNCTION asignar_rol_cliente();

DROP TRIGGER IF EXISTS on_auth_user_login ON auth.users;
CREATE TRIGGER on_auth_user_login
AFTER UPDATE OF last_sign_in_at ON auth.users
FOR EACH ROW WHEN (OLD.last_sign_in_at IS DISTINCT FROM NEW.last_sign_in_at)
EXECUTE FUNCTION public.handle_user_login();

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_user_login();

CREATE POLICY "Lectura pública perfiles" ON usuarios FOR SELECT USING (true);
CREATE POLICY "Inserción perfiles" ON usuarios FOR INSERT WITH CHECK (auth.uid() = id_cliente OR auth.role() = 'service_role');
CREATE POLICY "Edición propia y admin" ON usuarios FOR UPDATE 
USING (auth.uid() = id_cliente OR public.es_admin())
WITH CHECK (
    (auth.uid() = id_cliente AND id_role = (SELECT id_role FROM usuarios WHERE id_cliente = auth.uid())) 
    OR public.es_admin()
);

CREATE POLICY "Ver productos" ON gestion_productos FOR SELECT USING (true);
CREATE POLICY "Admin productos" ON gestion_productos FOR ALL USING (public.es_admin() OR auth.role() = 'service_role');

CREATE POLICY "Admin CRUD carrito" ON carrito FOR ALL USING (public.es_admin());
CREATE POLICY "Cliente CRUD limitado carrito" ON carrito FOR ALL 
USING (id_cliente = auth.uid())
WITH CHECK (id_cliente = auth.uid());

CREATE POLICY "Admin CRUD pedidos" ON pedidos FOR ALL USING (public.es_admin());
CREATE POLICY "Cliente ver pedidos" ON pedidos FOR SELECT USING (id_cliente = auth.uid());

CREATE POLICY "Admin CRUD facturas" ON facturas FOR ALL USING (public.es_admin());
CREATE POLICY "Cliente ver facturas" ON facturas FOR SELECT USING (id_cliente = auth.uid());

CREATE POLICY "Admin CRUD detalle" ON pedido_detalle FOR ALL USING (public.es_admin());
CREATE POLICY "Cliente CRUD detalle" ON pedido_detalle FOR ALL 
USING (EXISTS (SELECT 1 FROM pedidos WHERE id_pedido = pedido_detalle.id_pedido AND id_cliente = auth.uid()))
WITH CHECK (
    public.es_admin() OR (
        id_pedido IN (SELECT id_pedido FROM pedidos WHERE id_cliente = auth.uid())
    )
);

CREATE POLICY "CRUD comentarios" ON comentarios FOR ALL USING (auth.uid() IS NOT NULL);

CREATE POLICY "Admin CRUD publicidad" 
ON publicidad 
FOR ALL 
TO authenticated
USING (public.es_admin())
WITH CHECK (public.es_admin());

CREATE POLICY "Publico ver publicidad activa" 
ON publicidad 
FOR SELECT 
USING (estado = true);

CREATE INDEX idx_publicidad_tipo_estado ON publicidad(tipo, estado);

ALTER TABLE metodos_pago ENABLE ROW LEVEL SECURITY;
ALTER TABLE facturas ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Lectura pública metodos" ON metodos_pago FOR SELECT USING (estado = true);
CREATE POLICY "Admin CRUD metodos" ON metodos_pago FOR ALL USING (public.es_admin());

CREATE POLICY "Admin CRUD facturas" ON facturas FOR ALL USING (public.es_admin());
CREATE POLICY "Cliente ver sus facturas" ON facturas FOR SELECT USING (id_cliente = auth.uid());

CREATE INDEX idx_facturas_id_pago ON facturas(id_pago);
CREATE INDEX idx_metodos_pago_id_pago ON metodos_pago(id_pago);

INSERT INTO roles (nombre_role, descripcion) VALUES 
('cliente', 'Acceso estándar'),
('admin', 'Administrador total'),
('visitante', 'Solo lectura')
ON CONFLICT (nombre_role) DO NOTHING;